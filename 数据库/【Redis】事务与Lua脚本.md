# 【Redis】事务与Lua脚本

## 基本事务

Redis 的事务是通过 **MULTI**、**EXEC** 、**DISCARD**  和 **WATCH** 、**UNWATCH** 这五个命令来完成。

Redis 的单个命令都是原子性的，所以这里需要确保事务性的对象是 **命令集（多个命令）** 。Redis 将命令集序列化并确保处于同一事务的 **命令集合连续且不被打断** 的执行。

**Redis 事务不支持回滚操作！ **

命令：

- **MULTI：用于标记事务块的开始** 。Redis 会将后续的命令逐个放入队列中，然后使用 EXEC 命令原子化地执行这个命令序列。
    - 语法：`multi`
- **EXEC：在一个事务中执行所有先前放入队列的命令，然后恢复正常的连接状态。** 
    - 语法：`exec`
- **DISCARD：清除所有先前在一个事务中放入队列的命令，然后恢复正常的连接状态** 。 清除所有先前在一个事务中放入队列的命令，然后恢复正常的连接状态。
    - 语法：`discard`
- **WATCH：当某个事务需要按条件执行** 时，就要使用这个命令将给定的 **键设置为受监控** 的状态。
    - 语法：`watch key [key…]`
- **UNWATCH：清除所有先前为一个事务监控的键** 。 
- 语法：`unwatch`

## Lua脚本

Redis 整合 Lua 是对 Redis 事务的补充。

### 什么是Lua ？

Lua 是一种轻量小巧的 **脚本语言** ，用标准 **C语言** 编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。

Lua  教程： [https://www.runoob.com/lua/lua-tutorial.html](https://www.runoob.com/lua/lua-tutorial.html)

### Redis中使用Lua的好处

- **减少网络开销** ，在 Lua 脚本中可以把多个命令放在同一个脚本中运行。
- **原子性、隔离性** ，Redis 会将整个脚本作为一个整体执行，中间不会被其他命令插入。换句话说，编写脚本的过程中无需担心会出现竞态条件。 
- **复用性** ，客户端发送的脚本会永远存储在 Redis 中，这意味着其他客户端可以复用这一脚本来完成同样的逻辑。