# 【Java开发笔记】微服务保护-Sentinel

## 1 Sentinel基本介绍

### 1.1 雪崩问题

微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。 

![1533829099748](./【Java开发笔记】微服务保护-Sentinel.assets/1533829099748.png)

如图，如果服务提供者 I 发生了故障，当前的应用的部分业务因为依赖于服务 I，因此也会被阻塞。此时，其它不依赖于服务 I 的业务似乎不受影响。

![1533829198240](./【Java开发笔记】微服务保护-Sentinel.assets/fxnts1.png)

但是，依赖服务 I 的业务请求被阻塞，用户不会得到响应，则 **tomcat 的这个线程不会释放**，于是越来越多的用户请求到来，越来越多的线程会阻塞：

![1533829307389](./【Java开发笔记】微服务保护-Sentinel.assets/tv48gd.png)

服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。那么，**依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了** ：

![image-20210715172710340](./【Java开发笔记】微服务保护-Sentinel.assets/83jzx0.png)

解决雪崩问题的常见方式主要有四种：

- 超时处理
- 仓壁模式（线程隔离）
- 熔断降级
- 流量控制

#### 超时处理

超时处理：**设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待** 。

![image-20210715172820438](./【Java开发笔记】微服务保护-Sentinel.assets/image-20210715172820438.png)



#### 仓壁模式（线程隔离）

仓壁模式来源于船舱的设计：

![image-20210715172946352](./【Java开发笔记】微服务保护-Sentinel.assets/image-20210715172946352.png)

船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，**将故障控制在一定范围内，避免整个船体都被淹没**。

于此类似，我们可以 **限定每个业务能使用的线程数，避免耗尽整个 tomcat 的资源，因此也叫 线程隔离** 。

![image-20210715173215243](./【Java开发笔记】微服务保护-Sentinel.assets/image-20210715173215243.png)

#### 熔断降级

**熔断降级** ：由 **断路器** 统计业务执行的 **异常比例**，如果超出阈值则会 **熔断** 该业务，**拦截访问该业务的一切请求** 。

断路器会统计访问某个服务的请求数量，异常比例：

![image-20210715173327075](./【Java开发笔记】微服务保护-Sentinel.assets/image-20210715173327075.png)

当发现访问服务 D 的请求异常比例过高时，认为服务 D 有导致雪崩的风险，会拦截访问服务 D 的一切请求，形成熔断：

![image-20210715173428073](./【Java开发笔记】微服务保护-Sentinel.assets/image-20210715173428073.png)

#### 流量控制

**流量控制**：限制业务访问的 QPS，**避免服务因流量的突增而故障** 。

![image-20210715173555158](./【Java开发笔记】微服务保护-Sentinel.assets/image-20210715173555158.png)

> **限流** 是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种 **预防** 措施。
>
> **超时处理、线程隔离、降级熔断 **是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种 **补救** 措施。

### 1.2 微服务保护技术对比

在 SpringCloud 当中支持多种服务保护技术：

- [Netfix Hystrix](https://github.com/Netflix/Hystrix)
- [Sentinel](https://github.com/alibaba/Sentinel)
- [Resilience4J](https://github.com/resilience4j/resilience4j)

早期比较流行的是 Hystrix 框架，但目前国内实用最广泛的还是阿里巴巴的 Sentinel 框架，这里我们做下对比：

|                |                  **Sentinel**                  |            **Hystrix**            |
| :------------: | :--------------------------------------------: | :-------------------------------: |
|    隔离策略    |                **信号量** 隔离                 | **线程池** 隔离 / **信号量** 隔离 |
|  熔断降级策略  |      基于 **慢调用比例** 或 **异常比例**       |         基于 **失败比率**         |
|  实时指标实现  |                    滑动窗口                    |      滑动窗口（基于 RxJava）      |
|    规则配置    |                 支持多种数据源                 |          支持多种数据源           |
|     扩展性     |                   多个扩展点                   |            插件的形式             |
| 基于注解的支持 |                      支持                      |               支持                |
|      限流      |        基于 QPS，支持基于调用关系的限流        |            有限的支持             |
|    流量整形    |            支持慢启动、匀速排队模式            |              不支持               |
| 系统自适应保护 |                      支持                      |              不支持               |
|     控制台     | 开箱即用，可配置规则、查看秒级监控、机器发现等 |              不完善               |
| 常见框架的适配 |     Servlet、Spring Cloud、Dubbo、gRPC 等      |   Servlet、Spring Cloud Netflix   |

























































































